<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>בחר מיקום</title>
<style>
  body { font-family: Arial; margin:0; padding:10px; }
  #map { height: 350px; width: 100%; border:1px solid #ccc; border-radius:8px; }
  #pac-input { width:100%; padding:10px; margin-bottom:10px; font-size:16px; box-sizing:border-box; }
</style>
</head>
<body>

<input id="pac-input" type="text" placeholder="חפש כתובת..." />

<div id="map"></div>

<script>
  function updateParentForm(addr, lat, lng) {
    const parentDoc = window.parent.document;

    // כתובת מלאה
    parentDoc.querySelector("#input_11").value = addr || "";

    // LAT
    parentDoc.querySelector("#input_14").value = lat || "";

    // LNG
    parentDoc.querySelector("#input_12").value = lng || "";
  }

  function initMap() {
    const start = { lat: 31.7029, lng: 35.1147 }; // ברירת מחדל – ביתר עילית

    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 14,
      center: start,
    });

    const marker = new google.maps.Marker({
      position: start,
      map: map,
      draggable: true,
    });

    // autocomplete
    const input = document.getElementById("pac-input");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", function () {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;

      // שינוי המפה
      if (place.geometry.viewport) {
        map.fitBounds(place.geometry.viewport);
      } else {
        map.setCenter(place.geometry.location);
        map.setZoom(16);
      }

      // שינוי המיקום של המרקר
      marker.setPosition(place.geometry.location);

      // עדכון לטופס
      updateParentForm(
        place.formatted_address,
        place.geometry.location.lat(),
        place.geometry.location.lng()
      );
    });

    // גרירת המרקר
    google.maps.event.addListener(marker, "dragend", function () {
      const pos = marker.getPosition();

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: pos }, function (results, status) {
        if (status === "OK" && results[0]) {
          updateParentForm(
            results[0].formatted_address,
            pos.lat(),
            pos.lng()
          );
        }
      });
    });
  }
</script>


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh1XXzy1hGTBUrXjtxCVkEnpBq4G0K0tQ&libraries=places&callback=initMap" async defer></script>
</body>
</html>

